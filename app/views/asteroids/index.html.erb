<!DOCTYPE html>
<html>
  <head>
    <title>Asteroids</title>
    <script>
  function printMessage(){
    document.getElementById("message").innerHTML = "Scores Saved";
    setTimeout(function() {
       document.getElementById("message").innerHTML = ""
    }, 2000)
  }
  function printFailedMessage(){
    document.getElementById("message").innerHTML = "Scores Could not be saved. Try again";
    setTimeout(function() {
       document.getElementById("message").innerHTML = ""
    }, 2000)
  }
  function bigEnough(number){
    return number > 400000
  }

  function saveScores() {

    Asteroids.name = document.getElementById("name").value;
    
    var string = document.getElementById("scores").innerHTML.substring(8);
    var array = string.split("&nbsp;&nbsp;&nbsp;");
    var scores = []
    for (var i = 0; i < array.length-1; i++){
      scores.push(Number(array[i]));
    }
    scores = scores.filter(bigEnough);
    Asteroids.succede = true;
    for (var i = 0; i < scores.length; i++){
      $.ajax({
        type: "POST",
        url: "/scores",
        data: {
          points: scores[i],
          name: Asteroids.name
        }, 
        success: function () {
          Asteroids.succede = Asteroids.succede || true
        },
        error: function () {
          Asteroids.succede = Asteroids.succede && false
        },
        async: false
      })
    }
    console.log(Asteroids.succede);
    if (Asteroids.succede){
      printMessage();
      document.getElementById("scores").innerHTML = "Scores: "
    } else {
      printFailedMessage()
    } 
  }
  </script>


  </head>

  <body>
    <canvas width="500" height="500" id="canvas"></canvas>
    <script>
      var canvas = document.getElementById('canvas');
      var c = canvas.getContext('2d');
    </script>

    <div id="points">Points</div>
    <div id="scores" class="scores">Your Scores: </div>
    <div id="level" class="lev">Level: </div>
    <div class="save">
    <label>
      Your Name
    <input type="text" id="name">
    </label>
    <button onclick="saveScores()">save your scores</button><br><br>
    <div id="message"></div>
    </div>

  

  <div class="highscores">
  <h3>High Scores</h3>
  <ul>
  <% scores = @scores.sort{ |a, b| b.points <=> a.points } %>
  <% rank = 1 %>
  <% while rank < 31 && rank-1 < scores.length %>
    <% score = scores[rank-1] %>
    <li><%= "#{rank}) #{score.name}: #{score.points}" %></li>
    <% rank += 1 %>
  <% end %>
  </ul>
  </div>

  </body>
</html>
